Annotation Cookbook
===================

Writing an annotation in ZTag is easy, and consists of writing a short Python class. You define what protocols the annotation should operate on and implement a single `process` function, and ZTag handles the rest.

## Terminology

ZTag has two main functions: *transforms* and *annotations*. Annotations run on the output of a transformation, and annotate the transformed data with any combination of device information, software and hardware details, and any other relevant information.

For example, one annotation might annotate any hosts that support export RSA ciphers in TLS with the tag <code>freakattack-vulnerable</code>, whereas another annotation might only annotate ASUS home routers with their make and model.

There are three types of annotated data that can be generated by an annotation: *local metadata*, *global metadata*, and *tags*.

<table>
  <tbody>
    <tr>
      <th>Local Metadata</th>
      <td>Key-value pairs added to host data at the given <code>(port, protocol, subprotocol)</code>tuple. Follows a predefined schema.</td>
      <td>
      <code>local_metadata.manufacturer = Manufacturer.MICROSOFT</code>
      </td>
    </tr>
    <tr>
      <th>Global Metadata</th>
      <td>Key-value pairs to host data at the <i>top</i> level. This will be merged across all <code>(port, protocol, subprotocol)</code> tuples. Follows a predefined schema.</td>
      <td><code>global_metadata.device_type = Type.SOHO_ROUTER</code>
    </tr>
    <tr>
      <th>Tags</th>
      <td>Set of strings added to host data at the <i>top</i> level. Does not follow a specific schema, but try not to needlessly create new values.</td>
      <td><code>tags.add("heartbleed-vulnerable")</code></td>
    </tr>
  </tbody>
</table>

## Creating an Annotation

In the root of the repository, run `./new_tag`. This will copy
`example/annotation.tmpl` to `ztag/annotations/$TAG_NAME.py` and populate it
with values based on your answers to a few questions.

To finish your tag, implement the method `def process(self, obj, meta)`
function. The argument `obj` is a Python dictionary that matches the JSON from
Censys for the specified `(port, protocol, subprotocol)` tuple. The `meta`
argument is a Python object containing the annotated data, and matches the
schema described below. Populate `meta` based on the values in `obj`.

Your implementation of `process` should modify and return `meta`, but should not
modify `obj`. Only set the properties on `meta` that your annotation can
determine. Optionally, your function can also return `None` to signify it cannot
annotate `obj`. This is functionally identical to returning `meta` unmodified.

## Schema

### Layout

```
metadata
  .local_metadata
    .manufacturer
    .product
    .version
    .revision
  .global_metadata
    .manufacturer
    .product
    .version
    .revision
    .device_type
    .os
    .os_version
    .os_revision
  .tags
```
### Types

<table>
  <tr>
    <th>metadata.local_metadata.manufacturer</th>
    <td>String Constant</td>
    <td><code>Manufacturer.MICROSOFT</code></td>
  </tr>
  <tr>
    <th>metadata.local_metadata.product</th>
    <td>String</td>
    <td><code>"IIS"</code></td>
  </tr>
  <tr>
    <th>metadata.local_metadata.version</th>
    <td>String</td>
    <td><code>"2012"</code></td>
  </tr>
  <tr>
    <th>metadata.local_metadata.revision</th>
    <td>String</td>
    <td><code>"R2"</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.manufacturer</th>
    <td>String Constant</td>
    <td><code>Manufacturer.LINKSYS</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.product</th>
    <td>String</td>
    <td><code>"WRT54G-L"</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.version</th>
    <td>String</td>
    <td><code>"3.1.0"</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.revision</th>
    <td>String</td>
    <td><code>"r2236"</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.device_type</th>
    <td>String Constant</td>
    <td><code>Type.SOHO_ROUTER</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.os</th>
    <td>String Constant</td>
    <td><code>OperatingSystem.WINDOWS</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.os_version</th>
    <td>String</td>
    <td><code>"XP"</code></td>
  </tr>
  <tr>
    <th>metadata.global_metadata.os_revision</th>
    <td>String</td>
    <td><code>"SP2"</code></td>
  </tr>
  <tr>
    <th>metadata.tags</th>
    <td>Set of Strings</td>
    <td><code>"heartbleed-vulnerable"</code></td>
  </tr>
</table>
